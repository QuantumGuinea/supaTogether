<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì´ë¯¸ì§€ ì† ë™ë¬¼ ì •ë³´ ì¶”ì¶œê¸°</title>
    <!-- Supabase JS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <h1>ì´ë¯¸ì§€ ì† ë™ë¬¼ ì •ë³´ ì¶”ì¶œê¸°</h1>
    <p>ì´ë¯¸ì§€ë¥¼ ì„ íƒí•œ í›„ "ì œì¶œ" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    <div>ìµœì¢…ì ìœ¼ë¡œ ì¶”ì¶œëœ ë°ì´í„° ê°’ì€ ê°œë°œìë„êµ¬(F12)ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸ˜€</div>
    <input type="file" id="imageInput" accept="image/*" />
    <button id="submitBtn">ì œì¶œ</button>
    <div id="result"></div>

    <!-- ê°„ë‹¨ uuidv4 ìƒì„± í•¨ìˆ˜ -->
    <script>
      function uuidv4() {
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
          (c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))).toString(16)
        );
      }
    </script>

    <script>
      // ---------------------------
      // API ë° Supabase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ ëŒ€ì²´)
      // ---------------------------
      const TOGETHER_API_KEY = ""; // Together API í‚¤
      const GROQ_API_KEY = ""; // GROQ API í‚¤
      const TOGETHER_API_ENDPOINT = "https://api.together.xyz/v1/chat/completions";
      const GROQ_API_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";

      // Supabase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ ëŒ€ì²´)
      const supabaseUrl = "https://plpkyqiigxrwvzzhngln.supabase.co"; // ì˜ˆ: https://abc123.supabase.co
      const supabaseAnonKey = ""; // Supabase anon í‚¤
      const supabaseBucket = "my-bucket/groqTogether"; // Supabase bucket ì´ë¦„ (ì™„ì „ ê³µê°œì—¬ì•¼ í•¨)
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

      // ---------------------------
      // (ì„ íƒì ) ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
      // ---------------------------
      async function checkUserPermission() {
        // ì˜ˆì‹œ: ë‹¨ìˆœ GET ìš”ì²­ (í•„ìš”ì— ë”°ë¼ ìˆ˜ì •)
        const response = await fetch(`${supabaseUrl}/rest/v1/MY_USER`, {
          method: "GET",
          headers: {
            apikey: supabaseAnonKey,
            Authorization: `Bearer ${supabaseAnonKey}`,
            "Content-Type": "application/json",
          },
        });
        if (!response.ok) {
          throw new Error("ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨");
        }
        return await response.json();
      }

      // ---------------------------
      // Supabaseì— ì´ë¯¸ì§€ ì—…ë¡œë“œ (public bucket ì‚¬ìš©)
      // ---------------------------
      async function uploadImageToSupabase(file) {
        const filename = `${uuidv4()}_${file.name}`;
        const { data, error } = await supabaseClient.storage
          .from(supabaseBucket)
          .upload(filename, file, {
            cacheControl: "3600",
            upsert: false,
          });
        if (error) throw error;
        // Supabaseì˜ ê³µê°œ CDN URL (í† í° ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥)
        const publicUrl = `${supabaseUrl}/storage/v1/object/public/${supabaseBucket}/${data.path}`;
        return publicUrl;
      }

      // ---------------------------
      // API ì‘ë‹µì—ì„œ JSON ë¶€ë¶„ ì¶”ì¶œ ë° ì•ˆì „í•œ íŒŒì‹±
      // ---------------------------
      function extractJSON(responseText) {
        const firstBrace = responseText.indexOf("{");
        const lastBrace = responseText.lastIndexOf("}");
        if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
          return responseText.substring(firstBrace, lastBrace + 1);
        }
        return responseText;
      }
      function safeJSONParse(text) {
        if (text.trim().startsWith("{")) {
          try {
            return JSON.parse(text);
          } catch (e) {
            console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", e);
          }
        }
        return text;
      }

      // ---------------------------
      // ì—¬ëŸ¬ API ê²°ê³¼ë¥¼ í•©ì˜í•˜ì—¬ ìµœì¢… ê²°ê³¼ ë„ì¶œ
      // ---------------------------
      function aggregateResults(results) {
        const keys = [
          "species",
          "size",
          "weight",
          "is_predator",
          "is_allowed_in_public",
        ];
        const aggregated = {};
        keys.forEach((key) => {
          const freq = {};
          results.forEach((result) => {
            if (result && result[key] !== undefined && result[key] !== "") {
              const value = result[key];
              freq[value] = (freq[value] || 0) + 1;
            }
          });
          let maxCount = 0;
          let candidate = null;
          for (const value in freq) {
            if (freq[value] > maxCount) {
              maxCount = freq[value];
              candidate = value;
            }
          }
          aggregated[key] = candidate;
        });
        return aggregated;
      }

      // ---------------------------
      // ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ ê° API í˜¸ì¶œ
      // ---------------------------
      document.getElementById("submitBtn").addEventListener("click", async () => {
        const fileInput = document.getElementById("imageInput");
        const resultDiv = document.getElementById("result");

        if (fileInput.files.length === 0) {
          alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        resultDiv.innerText = "ê¶Œí•œ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...";
        try {
          await checkUserPermission();
          console.log("ê¶Œí•œ í™•ì¸ ì™„ë£Œ");

          const file = fileInput.files[0];
          resultDiv.innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...";
          const imageUrl = await uploadImageToSupabase(file);
          console.log("ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê³µê°œ URL:", imageUrl);
          if (!imageUrl) {
            throw new Error("ì´ë¯¸ì§€ ê³µê°œ URLì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          }

          // supabaseAnonKeyë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€í•˜ì—¬, ê° APIê°€ ì´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•¨
          const imageUrlWithKey = `${imageUrl}?apikey=${supabaseAnonKey}`;
          
          // í”„ë¡¬í”„íŠ¸ ë©”ì‹œì§€ êµ¬ì„±
          const baseMessage = `
IMAGE_URL: ${imageUrl}
supabaseAnonKey : ${supabaseAnonKey}
keyë¥¼ ì¨ì„œ urlì— ì ‘ì† ê°€ëŠ¥ì—¬ë¶€ë¥¼ ì•Œë ¤ì£¼ê³ , ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤ë©´ ì´ë¯¸ì§€ì˜ ë‚´ìš© ì¸ì‹ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ì•Œë ¤ì¤˜`;

          const messages = [{ role: "user", content: baseMessage }];

          // ê° API ìš”ì²­ ë³¸ë¬¸ êµ¬ì„±
          const requestBodyTogether = {
            model: "meta-llama/Llama-Vision-Free",
            messages: messages,
            max_tokens: 512,
            temperature: 0.7,
            top_p: 0.7,
            top_k: 50,
            repetition_penalty: 1,
            stop: ["<|eot|>", "<|eom_id|>"],
            stream: false,
          };

          const requestBodyGroq90b = {
            model: "llama-3.2-90b-vision-preview",
            messages: messages,
            max_tokens: 512,
            temperature: 0.7,
            stop: ["<|eot|>", "<|eom_id|>"],
            stream: false,
          };

          const requestBodyGroq11b = {
            model: "llama-3.2-11b-vision-preview",
            messages: messages,
            max_tokens: 512,
            temperature: 0.7,
            stop: ["<|eot|>", "<|eom_id|>"],
            stream: false,
          };

          resultDiv.innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!\n\nì„¸ API ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";

          // ì„¸ APIë¥¼ ë™ì‹œì— í˜¸ì¶œ
          const [togetherResponse, groq90bResponse, groq11bResponse] = await Promise.all([
            fetch(TOGETHER_API_ENDPOINT, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${TOGETHER_API_KEY}`,
              },
              body: JSON.stringify(requestBodyTogether),
            }),
            fetch(GROQ_API_ENDPOINT, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${GROQ_API_KEY}`,
              },
              body: JSON.stringify(requestBodyGroq90b),
            }),
            fetch(GROQ_API_ENDPOINT, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${GROQ_API_KEY}`,
              },
              body: JSON.stringify(requestBodyGroq11b),
            }),
          ]);

          // ì—ëŸ¬ ì²´í¬
          if (!togetherResponse.ok) {
            const errorData = await togetherResponse.json();
            throw new Error(`Together API HTTP ì—ëŸ¬: ${togetherResponse.status} - ${JSON.stringify(errorData)}`);
          }
          if (!groq90bResponse.ok) {
            const errorData = await groq90bResponse.json();
            throw new Error(`GROQ 90b API HTTP ì—ëŸ¬: ${groq90bResponse.status} - ${JSON.stringify(errorData)}`);
          }
          if (!groq11bResponse.ok) {
            const errorData = await groq11bResponse.json();
            throw new Error(`GROQ 11b API HTTP ì—ëŸ¬: ${groq11bResponse.status} - ${JSON.stringify(errorData)}`);
          }

          const togetherData = await togetherResponse.json();
          const groq90bData = await groq90bResponse.json();
          const groq11bData = await groq11bResponse.json();

          let togetherOutput = togetherData?.choices?.[0]?.message?.content || JSON.stringify(togetherData, null, 2);
          let groq90bOutput = groq90bData?.choices?.[0]?.message?.content || JSON.stringify(groq90bData, null, 2);
          let groq11bOutput = groq11bData?.choices?.[0]?.message?.content || JSON.stringify(groq11bData, null, 2);

          const togetherJsonText = extractJSON(togetherOutput);
          const groq90bJsonText = extractJSON(groq90bOutput);
          const groq11bJsonText = extractJSON(groq11bOutput);

          const togetherResult = safeJSONParse(togetherJsonText);
          const groq90bResult = safeJSONParse(groq90bJsonText);
          const groq11bResult = safeJSONParse(groq11bJsonText);

          resultDiv.innerHTML = `
            <h2>Together API ê²°ê³¼</h2>
            <pre>${JSON.stringify(togetherResult, null, 2)}</pre>
            <h2>GROQ 90b API ê²°ê³¼</h2>
            <pre>${JSON.stringify(groq90bResult, null, 2)}</pre>
            <h2>GROQ 11b API ê²°ê³¼</h2>
            <pre>${JSON.stringify(groq11bResult, null, 2)}</pre>
          `;

          const finalAggregatedResult = aggregateResults([togetherResult, groq90bResult, groq11bResult]);
          console.log("ìµœì¢… í•©ì˜ ê²°ê³¼:", finalAggregatedResult);

          const finalResultDiv = document.createElement("div");
          finalResultDiv.innerHTML = `
            <h2>ìµœì¢… í•©ì˜ ê²°ê³¼ (finalAggregatedResult)</h2>
            <pre>${JSON.stringify(finalAggregatedResult, null, 2)}</pre>
          `;
          resultDiv.appendChild(finalResultDiv);
        } catch (error) {
          console.error(error);
          resultDiv.innerText = "ì—ëŸ¬ ë°œìƒ: " + error.message;
        }
      });
    </script>
  </body>
</html>
